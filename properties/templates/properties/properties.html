{% extends "base.html" %}
{% load static %}

<!-- Extra CSS -->
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/properties.css' %}" />
{% endblock %}

{% block page_header %}
<div class="container header-container">
    <div class="row">
        <div class="col"></div>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="overlay"></div>
<div class="container-fluid">
    <div class="top-container col-10 offset-1">
        <div class="col-md-6 top-container-info">
            <div class="row mt-4">
                <div class="col mt-3">
                    <h2 class="logo-font">Properties</h2>
                    <hr/>
                </div>
            </div>
            <div class="row mt-1 mb-2">
                <div class="col-12 col-md-6 order-md-first">
                    <div class="sort-select-wrapper w-50">
                        <form method="get" action="{% url 'property_list' %}">
                            <select id="sort-selector" name="sort" class="custom-select custom-select-sm rounded-0">
                                <option value="None_None" {% if not current_sorting %}selected{% endif %}>Sort by...</option>
                                <option value="price_asc" {% if current_sorting == 'price_asc' %}selected{% endif %}>Price (low to high)</option>
                                <option value="price_desc" {% if current_sorting == 'price_desc' %}selected{% endif %}>Price (high to low)</option>
                                <option value="name_asc" {% if current_sorting == 'name_asc' %}selected{% endif %}>Name (A-Z)</option>
                                <option value="name_desc" {% if current_sorting == 'name_desc' %}selected{% endif %}>Name (Z-A)</option>
                                <option value="location" {% if current_sorting == 'location' %}selected{% endif %}>Location</option>
                                <option value="property_type" {% if current_sorting == 'property_type' %}selected{% endif %}>Property Type</option>
                            </select>                        
                            <button type="submit" class="btn btn-primary mt-2">Apply</button>
                        </form>
                    </div>
                </div>
                <div class="col-12 col-md-6 my-auto order-md-last d-flex justify-content-center">
                    <p class="text-muted mt-3 text-center text-md-left">
                        {% if search_query or location_filter or type_filter or current_sorting != 'None_None' %}
                        <span class="small"><a href="{% url 'property_list' %}">All Properties</a> | </span>
                        {% endif %}
                        {{ page_obj.paginator.count }} Properties{% if search_query %} found for <strong>"{{ search_query }}"</strong>{% endif %}
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="product-container mb-3 col-10 offset-1">
    <div class="row">
        {% for property in page_obj %}
        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card h-100 border-0 text-center">
                {% if property.image %}
                <a href="{% url 'property_detail' property.id %}">
                    <img class="card-img-top img-fluid" src="{{ property.image.url }}" alt="{{ property.name }}" />
                </a>
                {% else %}
                <a href="{% url 'property_detail' property.id %}">
                    <img class="card-img-top img-fluid" src="{% static 'images/noimage.png' %}" alt="{{ property.name }}" />
                </a>
                {% endif %}
                <div class="card-body pb-0">
                    <p class="mb-2">{{ property.name }}</p>
                    <p class="small">{{ property.location }}</p>
                    <p class="mb-2">${{ property.price }}</p>
                    <p class="small">{{ property.size }} sq ft</p>
                </div>
            </div>
        </div>
        {% if forloop.counter|divisibleby:3 %}
        <div class="col-12 d-md-none d-lg-none mb-5">
            <hr/>
        </div>
        {% endif %}
        {% endfor %}
    </div>
</div>
<div class="pagination">
    <span class="step-links">
        {% if page_obj.has_previous %}
            <a href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}{% if location_filter %}&location={{ location_filter }}{% endif %}{% if type_filter %}&type={{ type_filter }}{% endif %}{% if current_sorting %}&sort={{ current_sorting }}{% endif %}">First</a>
            <a href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if location_filter %}&location={{ location_filter }}{% endif %}{% if type_filter %}&type={{ type_filter }}{% endif %}{% if current_sorting %}&sort={{ current_sorting }}{% endif %}">Previous</a>
        {% endif %}
        <span class="current">
            Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}.
        </span>
        {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if location_filter %}&location={{ location_filter }}{% endif %}{% if type_filter %}&type={{ type_filter }}{% endif %}{% if current_sorting %}&sort={{ current_sorting }}{% endif %}">Next</a>
            <a href="?page={{ page_obj.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}{% if location_filter %}&location={{ location_filter }}{% endif %}{% if type_filter %}&type={{ type_filter }}{% endif %}{% if current_sorting %}&sort={{ current_sorting }}{% endif %}">Last</a>
        {% endif %}
    </span>
</div>
<div class="help-button shadow-sm rounded-0">
    <a class="help-link d-flex h-100" href="{% url 'contact_us' %}">
        <i class="fa-solid fa-circle-info fa-bounce fa-xl mx-auto my-auto" style="color: #daa520;"></i>
    </a>
</div>
{% endblock %}

{% block postloadjs %}
{{ block.super }}

<script>
    $('#sort-selector').change(function () {
        var selector = $(this);
        var currentUrl = new URL(window.location);

        var selectedVal = selector.val();
        if (selectedVal != "None_None") {
            var sort = selectedVal.split("_")[0];
            var direction = selectedVal.split("_")[1];

            currentUrl.searchParams.set("sort", sort);
            currentUrl.searchParams.set("direction", direction);

            window.location.replace(currentUrl);
        } else {
            currentUrl.searchParams.delete("sort");
            currentUrl.searchParams.delete("direction");

            window.location.replace(currentUrl);
        }
    });
</script>
{% endblock %}
